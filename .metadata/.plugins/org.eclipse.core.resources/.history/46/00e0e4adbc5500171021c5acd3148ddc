package com.isban.p064informclustergroupalphabetical.actions;

import com.isb.portlet.fw.annotation.ActionHandler;
import com.isb.portlet.fw.annotation.PortletHandler;
import com.isb.portlet.fw.base.BaseActionHandler;
import com.isb.portlet.fw.base.FrameworkUtils;
import com.isb.portlet.fw.base.Scope;
import com.isban.p064informclustergroupalphabetical.integration.P064InfoClusterGroupAlphabeticalIntegration;
import com.isban.p064informclustergroupalphabetical.keys.P064InfoClusterGroupAlphabeticalConst;
import com.isban.portales.utilidades.commons.keys.GenericConstants;
import com.isban.portales.utilidades.commons.utils.GenericUtils;

import java.util.Locale;

import javax.portlet.PortletException;
import javax.portlet.PortletPreferences;

/**
 * Default action handler for MODE.EDIT
 */
@PortletHandler
public class P064InfoClusterGroupAlphabeticalEditAction extends BaseActionHandler {

	/**
	 * Default method handler for Mode.View
	 * 
	 * @return
	 * @throws PortletException
	 */
	@ActionHandler(action = P064InfoClusterGroupAlphabeticalConst.ACTION_W064INFOCLUSTERGROUPALPHABETICAL_EDIT)
	public String editPreferencesAction() throws PortletException {

		try {

			String prefParamVisual = getModelData(Scope.PARAMS, P064InfoClusterGroupAlphabeticalConst.PARAM_VISUAL,
					GenericConstants.CTE_EMPTY);

			PortletPreferences preferences = FrameworkUtils.getPreferences();
			preferences.setValue(P064InfoClusterGroupAlphabeticalConst.PREF_VISUAL, prefParamVisual);

			// RICHCOMBO AGRUPS
			String prefParamRCAgrup = "";
			String prefSelectValueRCIconoNotificaciones = getModelData(Scope.PARAMS,
					P064InfoClusterGroupAlphabeticalConst.RICHCOMBO_AGRUP_SELECT_ID);
			preferences.setValue(P064InfoClusterGroupAlphabeticalConst.LR_PREF_SELECT_VALUE_RICH_COMBO_AGRUP,
					prefSelectValueRCIconoNotificaciones);
			if (P064InfoClusterGroupAlphabeticalConst.RICHCOMBO_COMBO_OPTION_VALUE
					.equals(prefSelectValueRCIconoNotificaciones)) {
				prefParamRCAgrup = getModelData(Scope.PARAMS,
						P064InfoClusterGroupAlphabeticalConst.RICHCOMBO_AGRUP_SELECT_ACTION_ID,
						GenericConstants.CTE_EMPTY);
			} else if (P064InfoClusterGroupAlphabeticalConst.RICHCOMBO_INPUT_OPTION_VALUE
					.equals(prefSelectValueRCIconoNotificaciones)) {
				prefParamRCAgrup = getModelData(Scope.PARAMS,
						P064InfoClusterGroupAlphabeticalConst.RICHCOMBO_AGRUP_INPUT_ID, GenericConstants.CTE_EMPTY);
			}
			preferences.setValue(P064InfoClusterGroupAlphabeticalConst.LR_PREF_PARAM_VALUE_RICH_COMBO_AGRUP,
					prefParamRCAgrup);

			// RICHCOMBO BARRAS
			String prefParamRCBarra = "";
			String prefSelectValueRCEnlaceNotificacion = getModelData(Scope.PARAMS,
					P064InfoClusterGroupAlphabeticalConst.RICHCOMBO_BARRA_SELECT_ID);
			preferences.setValue(P064InfoClusterGroupAlphabeticalConst.LR_PREF_SELECT_VALUE_RICH_COMBO_BARRA,
					prefSelectValueRCEnlaceNotificacion);
			if (P064InfoClusterGroupAlphabeticalConst.RICHCOMBO_COMBO_OPTION_VALUE
					.equals(prefSelectValueRCEnlaceNotificacion)) {
				prefParamRCBarra = getModelData(Scope.PARAMS,
						P064InfoClusterGroupAlphabeticalConst.RICHCOMBO_BARRA_SELECT_ACTION_ID,
						GenericConstants.CTE_EMPTY);
			} else if (P064InfoClusterGroupAlphabeticalConst.RICHCOMBO_INPUT_OPTION_VALUE
					.equals(prefSelectValueRCEnlaceNotificacion)) {
				prefParamRCBarra = getModelData(Scope.PARAMS,
						P064InfoClusterGroupAlphabeticalConst.RICHCOMBO_BARRA_INPUT_ID, GenericConstants.CTE_EMPTY);
			}
			preferences.setValue(P064InfoClusterGroupAlphabeticalConst.LR_PREF_PARAM_VALUE_RICH_COMBO_BARRA,
					prefParamRCBarra);

			if (prefParamVisual.trim().equals(GenericConstants.CTE_EMPTY)) {
				setModelData(Scope.REQUEST, GenericConstants.MSG_ALLMANDATORYPREFS_NOTFILLED,
						GenericConstants.CTE_TRUE);
			} else {
				preferences.store();
				setModelData(Scope.REQUEST, P064InfoClusterGroupAlphabeticalConst.MSG_SAVESUCCESFULPREFERENCES,
						GenericConstants.CTE_TRUE);
			}

		} catch (Exception e) {
			// Some error happens. Show error and send error message
			FrameworkUtils.getLogger().error(GenericConstants.MSG_UNEXPECTEDERRORINPREFERENCES, e);
			FrameworkUtils.setModelData(Scope.REQUEST, GenericConstants.MSG_ERRORPREFERENCES,
					GenericConstants.CTE_TRUE);
		}

		return P064InfoClusterGroupAlphabeticalConst.RENDER_W064INFOCLUSTERGROUPALPHABETICAL_EDIT;
	}

	/**
	 * Action get agrups.
	 *
	 * @return the string
	 * @throws PortletException
	 *             the portlet exception
	 */
	@ActionHandler(action = P064InfoClusterGroupAlphabeticalConst.ACTION_GET_AGRUPS)
	public String actionGetAgrups() throws PortletException {
		try {

			Locale currentLocale = FrameworkUtils.getLocale();
			String language = currentLocale.toString();
			String cacheKey = P064InfoClusterGroupAlphabeticalConst.CACHE_AGRUPLIST + language;
			// Se anaden parametros a request

			String defaultValueSelectAction = getModelData(Scope.PARAMS,
					P064InfoClusterGroupAlphabeticalConst.DEFAULT_VALUE_ACTION);
			setModelData(Scope.REQUEST, P064InfoClusterGroupAlphabeticalConst.DEFAULT_VALUE_ACTION,
					defaultValueSelectAction);

			String defaultValueSelect = getModelData(Scope.PARAMS,
					P064InfoClusterGroupAlphabeticalConst.DEFAULT_VALUE_ID_RC_SELECT);
			setModelData(Scope.REQUEST, P064InfoClusterGroupAlphabeticalConst.PARAM_DEFAULT_RICH_COMBO_AGRUP_SELECT,
					defaultValueSelect);

			String defaultActionSelect = (String) getModelData(Scope.PARAMS,
					P064InfoClusterGroupAlphabeticalConst.DEFAULT_VALUE_ID_RC_ACTION_SELECT);
			setModelData(Scope.REQUEST, P064InfoClusterGroupAlphabeticalConst.DEFAULT_VALUE_ID_RC_ACTION_SELECT,
					defaultActionSelect);

			// se recupera la lista de 'Agrups'
			// String subTypeAgrup =
			// FrameworkUtils.getPortletProperty(W055CustomInfoConst.PROPERTY_SUBTYPE_INFO);
			TipoAgrupadorPreferencias agrupTipoPrefs = null;
			try {
				agrupTipoPrefs = (TipoAgrupadorPreferencias) FrameworkUtils.getModelData(Scope.PORTLET_CACHE, cacheKey);
			} catch (Exception e) {
				FrameworkUtils.getLogger().debug(e.getMessage(), e);
			}
			if (agrupTipoPrefs == null || agrupTipoPrefs.getPreferencia().size() == 0) {
				agrupTipoPrefs = P064InfoClusterGroupAlphabeticalIntegration.getSanAgrupadorPreferencias(
						P064InfoClusterGroupAlphabeticalConst.PROPERTY_SUBTYPE_AGRUP, language,
						GenericUtils.getPortalForFatwire(), GenericUtils.getProtocolType(getRequest()));
				FrameworkUtils.setModelData(Scope.PORTLET_CACHE, cacheKey, agrupTipoPrefs);
			}
			setModelData(Scope.REQUEST, P064InfoClusterGroupAlphabeticalConst.BEANID_TIPO_PREF_DATA, agrupTipoPrefs);

			// Se anade mensaje de ok
			setModelData(Scope.REQUEST, P064InfoClusterGroupAlphabeticalConst.PARAM_STATUS_ACTION,
					P064InfoClusterGroupAlphabeticalConst.OK);
		} catch (Exception e) {
			FrameworkUtils.getLogger().error(e.getMessage(), e);
			// Se anade mensaje de error
			setModelData(Scope.REQUEST, P064InfoClusterGroupAlphabeticalConst.PARAM_STATUS_ACTION,
					P064InfoClusterGroupAlphabeticalConst.ERR);
		}

		return getCurrentView();
	}

	/**
	 * Action get barras.
	 *
	 * @return the string
	 * @throws PortletException
	 *             the portlet exception
	 */
	@ActionHandler(action = P064InfoClusterGroupAlphabeticalConst.ACTION_GET_BARRAS)
	public String actionGetBarras() throws PortletException {
		try {

			Locale currentLocale = FrameworkUtils.getLocale();
			String language = currentLocale.toString();
			String cacheKey = P064InfoClusterGroupAlphabeticalConst.CACHE_BARRALIST + language;
			// Se anaden parametros a request

			String defaultValueSelectAction = getModelData(Scope.PARAMS,
					P064InfoClusterGroupAlphabeticalConst.DEFAULT_VALUE_ACTION);
			setModelData(Scope.REQUEST, P064InfoClusterGroupAlphabeticalConst.DEFAULT_VALUE_ACTION,
					defaultValueSelectAction);

			String defaultValueSelect = getModelData(Scope.PARAMS,
					P064InfoClusterGroupAlphabeticalConst.DEFAULT_VALUE_ID_RC_SELECT);
			setModelData(Scope.REQUEST, P064InfoClusterGroupAlphabeticalConst.PARAM_DEFAULT_RICH_COMBO_BARRA_SELECT,
					defaultValueSelect);

			String defaultActionSelect = (String) getModelData(Scope.PARAMS,
					P064InfoClusterGroupAlphabeticalConst.DEFAULT_VALUE_ID_RC_ACTION_SELECT);
			setModelData(Scope.REQUEST, P064InfoClusterGroupAlphabeticalConst.DEFAULT_VALUE_ID_RC_ACTION_SELECT,
					defaultActionSelect);

			// se recupera la lista de 'Barras'
			// String subTypeBarra =
			// FrameworkUtils.getPortletProperty(W055CustomInfoConst.PROPERTY_SUBTYPE_INFO);
			TipoAgrupadorPreferencias barraTipoPrefs = null;
			try {
				barraTipoPrefs = (TipoAgrupadorPreferencias) FrameworkUtils.getModelData(Scope.PORTLET_CACHE, cacheKey);
			} catch (Exception e) {				
				FrameworkUtils.getLogger().debug(e.getMessage(),e);
			}
			if (barraTipoPrefs == null || barraTipoPrefs.getPreferencia().size() == 0) {
				barraTipoPrefs = P064InfoClusterGroupAlphabeticalIntegration.getSanAgrupadorPreferencias(
						P064InfoClusterGroupAlphabeticalConst.PROPERTY_SUBTYPE_ENLACE, language,
						GenericUtils.getPortalForFatwire(), GenericUtils.getProtocolType(getRequest()));
				FrameworkUtils.setModelData(Scope.PORTLET_CACHE, cacheKey, barraTipoPrefs);
			}
			setModelData(Scope.REQUEST, P064InfoClusterGroupAlphabeticalConst.BEANID_TIPO_PREF_DATA, barraTipoPrefs);

			// Se anade mensaje de ok
			setModelData(Scope.REQUEST, P064InfoClusterGroupAlphabeticalConst.PARAM_STATUS_ACTION,
					P064InfoClusterGroupAlphabeticalConst.OK);
		} catch (Exception e) {
			FrameworkUtils.getLogger().error(e.getMessage(), e);
			// Se anade mensaje de error
			setModelData(Scope.REQUEST, P064InfoClusterGroupAlphabeticalConst.PARAM_STATUS_ACTION,
					P064InfoClusterGroupAlphabeticalConst.ERR);
		}

		return getCurrentView();
	}

}
